name: Update Strava Heatmap

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC (midnight CST)
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  update-heatmap:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
      
      - name: Build strava-heatmap
        run: |
          go build -o strava-heatmap ./cmd/strava-heatmap
      
      - name: Generate heatmap SVG
        env:
          STRAVA_CLIENT_ID: ${{ secrets.STRAVA_CLIENT_ID }}
          STRAVA_CLIENT_SECRET: ${{ secrets.STRAVA_CLIENT_SECRET }}
          STRAVA_REFRESH_TOKEN: ${{ secrets.STRAVA_REFRESH_TOKEN }}
        run: |
          ./strava-heatmap -generate > heatmap.svg
      
      - name: Calculate GitHub contribution statistics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch total contributions across all years using GitHub API
          # GitHub API requires year-by-year queries for historical data
          ACCOUNT_START_YEAR=2019
          CURRENT_YEAR=$(date +%Y)
          TOTAL_CONTRIBUTIONS=0
          
          for YEAR in $(seq $ACCOUNT_START_YEAR $CURRENT_YEAR); do
            YEAR_START="${YEAR}-01-01T00:00:00Z"
            YEAR_END="${YEAR}-12-31T23:59:59Z"
            
            YEAR_CONTRIBUTIONS=$(curl -s -H "Authorization: bearer $GITHUB_TOKEN" -X POST -d "{
              \"query\": \"query { user(login: \\\"ImmortalDemonGod\\\") { contributionsCollection(from: \\\"$YEAR_START\\\", to: \\\"$YEAR_END\\\") { contributionCalendar { totalContributions } } } }\"
            }" https://api.github.com/graphql | jq -r '.data.user.contributionsCollection.contributionCalendar.totalContributions')
            
            echo "Year $YEAR: $YEAR_CONTRIBUTIONS contributions"
            TOTAL_CONTRIBUTIONS=$((TOTAL_CONTRIBUTIONS + YEAR_CONTRIBUTIONS))
          done
          
          # Get account creation date (Nov 29, 2019 based on streak stats)
          ACCOUNT_START="2019-11-29"
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          # Calculate years since account creation
          DAYS_SINCE_START=$(( ( $(date -d "$CURRENT_DATE" +%s) - $(date -d "$ACCOUNT_START" +%s) ) / 86400 ))
          YEARS_SINCE_START=$(echo "scale=2; $DAYS_SINCE_START / 365.25" | bc)
          
          # Calculate commits per year
          COMMITS_PER_YEAR=$(echo "scale=0; $TOTAL_CONTRIBUTIONS / $YEARS_SINCE_START" | bc)
          
          echo "Total contributions (all time): $TOTAL_CONTRIBUTIONS"
          echo "Years active: $YEARS_SINCE_START"
          echo "Commits per year: $COMMITS_PER_YEAR"
          
          # Save to environment
          echo "COMMITS_PER_YEAR=$COMMITS_PER_YEAR" >> $GITHUB_ENV
          echo "TOTAL_CONTRIBUTIONS=$TOTAL_CONTRIBUTIONS" >> $GITHUB_ENV
      
      - name: Determine streak display mode
        run: |
          STREAK_JSON=$(curl -s "https://streak-stats.demolab.com?user=ImmortalDemonGod&type=json")
          CURRENT_STREAK=$(echo "$STREAK_JSON" | jq -er '.currentStreak.length' 2>/dev/null || echo "error")
          if [ "$CURRENT_STREAK" = "error" ]; then
            echo "Streak API error or missing currentStreak; defaulting to hide streak and preserving cached image"
            echo "STREAK_API_STATUS=error" >> $GITHUB_ENV
            echo "HIDE_CURRENT_STREAK=true" >> $GITHUB_ENV
          else
            echo "Current streak length: $CURRENT_STREAK"
            if [ "$CURRENT_STREAK" -ge 7 ]; then
              HIDE_CURRENT_STREAK=false
            else
              HIDE_CURRENT_STREAK=true
            fi
            echo "HIDE_CURRENT_STREAK=$HIDE_CURRENT_STREAK" >> $GITHUB_ENV
            echo "STREAK_API_STATUS=ok" >> $GITHUB_ENV
          fi
      
      - name: Cache GitHub streak card image
        run: |
          if [ "${{ env.STREAK_API_STATUS }}" = "error" ]; then
            echo "Skipping streak card download due to API error; keeping existing image"
            exit 0
          fi
          HIDE="${{ env.HIDE_CURRENT_STREAK }}"
          URL="https://streak-stats.demolab.com?user=ImmortalDemonGod&theme=dark&hide_border=true&background=45,050a12,0b1220,111827&ring=58a6ff&fire=ffd166&currStreakLabel=58a6ff&card_width=400&hide_current_streak=${HIDE}"
          echo "Fetching streak card image"
          if ! curl -sS "$URL" -o streak-card.png; then
            echo "Warning: failed to download streak card; keeping existing file if present" >&2
          fi

      - name: Fetch Strava statistics (rolling 365 days)
        env:
          STRAVA_CLIENT_ID: ${{ secrets.STRAVA_CLIENT_ID }}
          STRAVA_CLIENT_SECRET: ${{ secrets.STRAVA_CLIENT_SECRET }}
          STRAVA_REFRESH_TOKEN: ${{ secrets.STRAVA_REFRESH_TOKEN }}
        run: |
          # Get access token
          ACCESS_TOKEN=$(curl -s -X POST https://www.strava.com/oauth/token \
            -F client_id=$STRAVA_CLIENT_ID \
            -F client_secret=$STRAVA_CLIENT_SECRET \
            -F grant_type=refresh_token \
            -F refresh_token=$STRAVA_REFRESH_TOKEN | jq -r '.access_token')
          
          # Calculate timestamp for 1 year ago
          ONE_YEAR_AGO=$(date -d '365 days ago' +%s)
          
          # Fetch all activities from last 365 days (paginated)
          echo "[]" > /tmp/all_activities.json
          PAGE=1
          
          while [ $PAGE -le 10 ]; do  # Max 10 pages (2000 activities) to prevent infinite loops
            echo "Fetching page $PAGE..."
            curl -s -H "Authorization: Bearer $ACCESS_TOKEN" \
              "https://www.strava.com/api/v3/athlete/activities?per_page=200&page=$PAGE&after=$ONE_YEAR_AGO" \
              > /tmp/page_$PAGE.json
            
            # Check if page has activities
            ACTIVITY_COUNT=$(jq 'length' /tmp/page_$PAGE.json)
            echo "Page $PAGE has $ACTIVITY_COUNT activities"
            
            if [ "$ACTIVITY_COUNT" -eq 0 ]; then
              echo "No more activities, stopping"
              break
            fi
            
            # Append to all activities using file-based approach
            jq -s 'add' /tmp/all_activities.json /tmp/page_$PAGE.json > /tmp/temp.json
            mv /tmp/temp.json /tmp/all_activities.json
            
            PAGE=$((PAGE + 1))
          done
          
          # Calculate stats from all activities using the file
          TOTAL_ACTIVITIES=$(jq 'length' /tmp/all_activities.json)
          TOTAL_DISTANCE=$(jq '[.[].distance] | add / 1000 | round' /tmp/all_activities.json)
          TOTAL_TIME=$(jq '[.[].moving_time] | add / 3600 | round' /tmp/all_activities.json)
          ACTIVE_DAYS=$(jq '[.[].start_date | split("T")[0]] | unique | length' /tmp/all_activities.json)
          
          echo "Calculated stats: $TOTAL_ACTIVITIES activities, $TOTAL_DISTANCE km, $TOTAL_TIME hours, $ACTIVE_DAYS days"
          
          # Save to environment for next step
          echo "TOTAL_ACTIVITIES=$TOTAL_ACTIVITIES" >> $GITHUB_ENV
          echo "TOTAL_DISTANCE=$TOTAL_DISTANCE" >> $GITHUB_ENV
          echo "TOTAL_TIME=$TOTAL_TIME" >> $GITHUB_ENV
          echo "ACTIVE_DAYS=$ACTIVE_DAYS" >> $GITHUB_ENV
      
      - name: Update README with image reference and stats
        run: |
          # Create the stats line
          STATS_LINE="**${{ env.TOTAL_ACTIVITIES }} activities** â€¢ **${{ env.TOTAL_DISTANCE }} km** â€¢ **${{ env.TOTAL_TIME }} hours** â€¢ **${{ env.ACTIVE_DAYS }} active days**"
          
          # Create the image reference with absolute URL
          IMAGE_TAG='![Strava Activity Heatmap](https://raw.githubusercontent.com/ImmortalDemonGod/ImmortalDemonGod/master/heatmap.svg)'
          
          # Update README between markers with both image and stats
          awk -v img="$IMAGE_TAG" -v stats="$STATS_LINE" '
          /<!-- STRAVA-HEATMAP-START -->/ {
            print
            print ""
            print img
            print ""
            print stats
            skip=1
            next
          }
          /<!-- STRAVA-HEATMAP-END -->/ {skip=0}
          !skip
          ' README.md > README.tmp && mv README.tmp README.md
      
      - name: Update README_redesign with GitHub stats
        run: |
          # Create the commits/year line
          COMMITS_LINE="- **ðŸ“Š High-Velocity Iteration:** ~${{ env.COMMITS_PER_YEAR }} commits/year"
          
          # Update README_redesign.md between markers
          awk -v commits="$COMMITS_LINE" '
          /<!-- GITHUB-STATS-START -->/ {
            print
            print commits
            skip=1
            next
          }
          /<!-- GITHUB-STATS-END -->/ {skip=0}
          !skip
          ' README_redesign.md > README_redesign.tmp && mv README_redesign.tmp README_redesign.md
      
      - name: Update streak card in README_redesign
        run: |
          awk '
          /<!-- STREAK-CARD-START -->/ {
            print "<!-- STREAK-CARD-START -->"
            print "<p align=\"right\">"
            print "  <img align=\"right\" src=\"https://raw.githubusercontent.com/ImmortalDemonGod/ImmortalDemonGod/master/streak-card.png\" alt=\"GitHub Streak Stats\" style=\"max-width: 100%%; width: 400px;\"/>"
            print "</p>"
            print "<!-- STREAK-CARD-END -->"
            skip=1
            next
          }
          /<!-- STREAK-CARD-END -->/ {skip=0; next}
          !skip
          ' README_redesign.md > README_redesign.tmp && mv README_redesign.tmp README_redesign.md
      
      - name: Commit updated README and heatmap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md README_redesign.md heatmap.svg
          if [ -f streak-card.png ]; then
            git add streak-card.png
          fi
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update Strava heatmap and GitHub stats [automated]"
            git push
          fi
